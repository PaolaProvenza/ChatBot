<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovAI!</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chat.css">
</head>
<body>

    <!-- Sfondo video e immagine -->
    <img src="immagini/Inizio.png" class="img-sfondo-iniziale">
    <video autoplay muted loop playsinline class="video">
        <source src="video/video.mp4" type="video/mp4">
    </video>

    <div class="right-panel">
        <div id="messageBox" class="message-box"></div>

        <!-- Start Screen -->
        <div class="start-screen" id="startScreen">
            <h1>NovAI!</h1>
            <p>Accedi e chatta con me.</p>
            <button class="button" id="enterBtn">
                <span>NEXT</span>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 66 43">
                    <polygon points="39.58,4.46 44.11,0 66,21.5 44.11,43 39.58,38.54 56.94,21.5"></polygon>
                    <polygon points="19.79,4.46 24.32,0 46.21,21.5 24.32,43 19.79,38.54 37.15,21.5"></polygon>
                    <polygon points="0,4.46 4.53,0 26.42,21.5 4.53,43 0,38.54 17.36,21.5"></polygon>
                </svg>
            </button>
        </div>

        <!-- Login / Sign Up / Reset Container -->
        <div class="container" id="loginBox">

            <!-- LOGIN FORM -->
            <form class="form" id="loginForm">
                <div class="back-arrow backBtnLogin">
                    <svg viewBox="0 0 24 24">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <p id="heading">Login</p>                

                <div class="field">
                    <input id="loginUsername" class="input-field" type="text" placeholder="Username"  maxlength="30">
                </div>
                <div class="field password-field">
                    <input id="loginPassword" class="input-field password-input" type="password" placeholder="Password" maxlength="15">
                    <img src="immagini/hide2.png" class="eyeicon toggle-password">
                </div>
                

                <div class="btn">
                    <button type="submit" class="button1" id="loginBtn">Login</button>
                    <button type="button" class="button2" id="showSignUpBtn">Sign Up</button>
                </div>

                <button type="submit" class="button3" id="forgotPassword">Forgot Password</button>
            </form>

            <!-- SIGN UP FORM -->
            <form class="form2" id="signForm" style="display:none;">
                <div class="back-arrow backBtnSign">
                    <svg viewBox="0 0 24 24">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <p id="heading">Sign Up</p>
            
                <div class="field">
                    <input id="signNickname" class="input-field" type="text" placeholder="Nickname" maxlength="30">
                </div>
            
                <div class="field">
                    <input id="signUsername" class="input-field" type="text" placeholder="Username (unico)" maxlength="30">
                </div>
            
                <div class="field password-field">
                    <input id="signPassword" class="input-field password-input" type="password" placeholder="Password" maxlength="15">
                    <img src="immagini/hide2.png" class="eyeicon toggle-password">
                </div>
                
                
            
                <div class="btn">
                    <button type="submit" class="button2" id="joinBtn">Join Us</button>
                </div>
            </form>
            

            <!-- RESET PASSWORD FORM -->
            <form class="form2" id="resetForm" style="display:none;" autocomplete="off">
                <div class="back-arrow backBtnReset">
                    <svg viewBox="0 0 24 24">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </div>
                <p id="heading">Change Password</p>
            
                <div class="field">
                    <input id="resetNickname" class="input-field" type="text" placeholder="Nickname" maxlength="30">
                </div>
            
                <div class="field">
                    <input id="resetUsername" class="input-field" type="text" placeholder="Username" maxlength="30">
                </div>
            
                <div class="field password-field">
                    <input id="resetPassword" class="input-field password-input" type="password" placeholder="New Password" maxlength="15" autocomplete="new-password">
                    <img src="immagini/hide2.png" class="eyeicon toggle-password">
                </div>                
                
            
                <div class="btn">
                    <button type="submit" class="button2" id="changePasswordBtn">Change</button>
                </div>
            </form>
            

        </div>
    </div>

<script>
const enterBtn = document.getElementById("enterBtn");
const startScreen = document.getElementById("startScreen");
const loginBox = document.getElementById("loginBox");
const loginForm = document.getElementById("loginForm");
const signForm = document.getElementById("signForm");
const resetForm = document.getElementById("resetForm");

const loginBtn = document.getElementById("loginBtn");
const showSignUpBtn = document.getElementById("showSignUpBtn");
const joinBtn = document.getElementById("joinBtn");
const changePasswordBtn = document.getElementById("changePasswordBtn");
const forgotBtn = document.getElementById("forgotPassword");
const messageBox = document.getElementById("messageBox");
// RESET PASSWORD FORM
resetForm.addEventListener("submit", async (e) => {
    e.preventDefault(); // Blocca il comportamento di default (anche Enter)

    const nickname = document.getElementById("resetNickname").value.trim();
    const username = document.getElementById("resetUsername").value.trim();
    const newPassword = document.getElementById("resetPassword").value.trim();

    if (!nickname || !username || !newPassword) {
        showMessage("Compila tutti i campi", "error");
        return;
    }

    try {
        const res = await fetch("/change-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ nickname, username, newPassword })
        });

        const data = await res.json();

        if (res.ok) {
            showMessage("Password aggiornata! Effettua il login.", "success");
            resetForm.reset();
            resetForm.style.display = "none";
            loginForm.style.display = "block";
        } else {
            showMessage(data.message || "Errore", "error");
        }
    } catch (err) {
        console.error(err);
        showMessage("Errore di connessione", "error");
    }
});



loginForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();

    if (!username || !password) {
        showMessage("Compila tutti i campi", "error");
        return;
    }

    const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
    });

    const data = await res.json();

    if (res.ok) {
        localStorage.setItem("loggedUser", data.nickname);
        showMessage("Login effettuato con successo!", "success");
        setTimeout(() => {
            window.location.href = "chat.html";
        }, 1000);
    } else {
        showMessage(data.message || "Credenziali errate", "error");
    }
});

document.querySelectorAll(".toggle-password").forEach(icon => {
    icon.addEventListener("click", function() {
        const input = this.parentElement.querySelector(".password-input");

        if (input.type === "password") {
            input.type = "text";
            this.src = "immagini/view2.png";
        } else {
            input.type = "password";
            this.src = "immagini/hide2.png";
        }
    });
});

// NEXT button
enterBtn.onclick = () => {
    startScreen.style.display = "none";
    loginBox.style.display = "block";
    loginForm.style.display = "block";
    signForm.style.display = "none";
};

// LOGIN
loginBtn.onclick = async () => {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  if (!username || !password) {
    showMessage("Compila tutti i campi", "error");
    return;
  }

  const res = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username, password })
  });

  const data = await res.json();

  if (res.ok) {
    // Salva il nickname ricevuto dal server
    localStorage.setItem("loggedUser", data.nickname);  

    document.getElementById("loginUsername").value = "";
    document.getElementById("loginPassword").value = "";

    showMessage("Login effettuato con successo!", "success");

    setTimeout(() => {
      window.location.href = "chat.html";
    }, 1000);
  } else {
    showMessage(data.message || "Credenziali errate", "error");
  }
};



// SHOW SIGN UP
showSignUpBtn.onclick = () => {
    loginForm.style.display = "none";
    signForm.style.display = "block";
};

// SIGN UP
joinBtn.onclick = async (e) => {
    e.preventDefault();

    const nickname = document.getElementById("signNickname").value.trim();
    const username = document.getElementById("signUsername").value.trim();
    const password = document.getElementById("signPassword").value.trim();

    console.log("INVIO AL SERVER:", { nickname, username, password });

    if (!nickname || !username || !password) {
        showMessage("Compila tutti i campi", "error");
        return;
    }

    const res = await fetch("/signup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nickname, username, password })
    });

    const data = await res.json();

    if (res.ok) {
        showMessage("Registrazione effettuata! Effettua il login.", "success");

        document.getElementById("signNickname").value = "";
        document.getElementById("signUsername").value = "";
        document.getElementById("signPassword").value = "";

        signForm.style.display = "none";
        loginForm.style.display = "block";
    } else {
        showMessage(data.message || "Errore registrazione", "error");
    }
};


// FORGOT PASSWORD
forgotBtn.onclick = (e) => {
    e.preventDefault();
    loginForm.style.display = "none";
    signForm.style.display = "none";
    resetForm.style.display = "block";
};

// RESET PASSWORD



// BACK BUTTONS
document.querySelector(".backBtnLogin").onclick = () => {
    loginBox.style.display = "none";
    startScreen.style.display = "flex";
};
document.querySelector(".backBtnSign").onclick = () => {
    signForm.style.display = "none";
    loginForm.style.display = "block";
};
document.querySelector(".backBtnReset").onclick = () => {
    resetForm.style.display = "none";
    loginForm.style.display = "block";
};

// MESSAGE
function showMessage(msg, type = "success") {
    messageBox.textContent = msg;
    messageBox.className = `message-box show ${type}`;
    setTimeout(() => { messageBox.className = `message-box ${type}`; }, 2000);
}
</script>
</body>
</html>
