<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NovAI!</title>

    <!-- Collegamento al file CSS esterno -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="chat.css">
</head>

<body>
    <div class="chat-background">
        <img src="immagini/Inizio.png" class="img-sfondo-chat">
        <video autoplay muted loop playsinline class="video">
            <source src="video/video.mp4" type="video/mp4">
        </video>
    </div>

    <div class="barra">
        <!--POI AGGIUNGIAMO IL LOGOUT DALLA CHAT-->
        <!--<button id="logoutBtn">Logout</button>-->

        <div class="chat-header">
            <h1 class="titolo">NovAI!</h1>
        </div>

        <div class="logo" id="logo">
            <img src="immagini/Logo.png" class="img-logo">
            <p class="utente"> </p>
        </div>
    </div>

    <div class="frame-chat" id="chatContainer">
      <!-- Area per i messaggi -->
      <div class="chat-messages" id="chatMessages"></div>
      
      <div class="message">
        <!-- Pulsante + per upload file -->
        <div class="fileUploadWrapper">
          <label for="file">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 337 337">
              <circle stroke-width="20" stroke="#6c6c6c" fill="none" r="158.5" cy="168.5" cx="168.5"></circle>
              <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M167.759 79V259"></path>
              <path stroke-linecap="round" stroke-width="25" stroke="#6c6c6c" d="M79 167.138H259"></path>
            </svg>
            <span class="tooltip">Add an image</span>
          </label>
          <input type="file" id="file" name="file" />
        </div>
      
        <!-- Input messaggio -->
        <input type="text" id="messageInput" placeholder="Message..." />
      
        <!-- Pulsante invio -->
        <button id="sendButton">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 664 663">
            <path
              fill="none"
              d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"
            ></path>
            <path
              stroke-linejoin="round"
              stroke-linecap="round"
              stroke-width="33.67"
              stroke="#6c6c6c"
              d="M646.293 331.888L17.7538 17.6187L155.245 331.888M646.293 331.888L17.753 646.157L155.245 331.888M646.293 331.888L318.735 330.228L155.245 331.888"
            ></path>
          </svg>
        </button>
      </div>
      
    </div>
</body>

<script>
const messageInput = document.getElementById("messageInput");
const sendButton = document.getElementById("sendButton");
const chatContainer = document.getElementById("chatContainer");
const chatMessages = document.getElementById("chatMessages");

function addMessageToChat(text, sender = "user") {
    if (!text.trim()) return; // evita messaggi vuoti

    const messageDiv = document.createElement("div");
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = text;

    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight; // scroll automatico
    messageInput.value = ""; // pulisce input
}
async function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;

    // Mostra subito il messaggio dell'utente
    addMessageToChat(text, "user");

    try {
        const res = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
        });

        const data = await res.json();

        // Mostra la risposta del bot
        addMessageToChat(data.reply, "bot");
    } catch (err) {
        console.error("Errore chat:", err);
        addMessageToChat("Errore di connessione", "bot");
    }

    messageInput.value = "";
}

// Click sul pulsante
sendButton.addEventListener("click", sendMessage);

// Invio con Enter
messageInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
    }
});


    fetch("/check-auth")
    .then(res => {
        if (!res.ok) window.location.href = "/";
    });


    logo.onclick = () => {
        console.log("Logo cliccato — qui torni indietro");
        window.location.href = "index.html";
    };

    //COLLEGATO AL BOTTONE DI LOGOUT
    //const logoutBtn = document.getElementById("logoutBtn");

    //logoutBtn.onclick = () => {
    // rimuove l’utente loggato da localStorage
    //localStorage.removeItem("loggedUser");

    //torna alla pagina di login
    //window.location.href = "index.html";
    //};

    window.addEventListener("DOMContentLoaded", () => {
    const nickname = localStorage.getItem("loggedUser");
    const userEl = document.querySelector(".utente");

    if (nickname && userEl) {
        userEl.textContent = nickname;  // <-- mostra il nickname corretto
    } else {
        userEl.textContent = "Utente"; // fallback
    }

    const data = JSON.parse(localStorage.getItem("transMessage"));
    if (data) {
        const messageBox = document.createElement("div");
        messageBox.id = "messageBox";
        messageBox.className = `message-box ${data.type} show`;
        messageBox.textContent = data.text;
        document.body.appendChild(messageBox);

        setTimeout(() => {
            messageBox.className = `message-box ${data.type}`;
        }, 2000);
        localStorage.removeItem("transMessage");
    }
});





</script>
</html>
